<?php// if bool is true then all modules details must be updated// else when bool is false then only update the modules in the mod_list arrayfunction shn_mm_register_cache($bool="true",$mod_list="",$status="installed"){	global $global;	global $conf;	$db=$global['db'];	if($bool=="true")	{        $mod_query = "SELECT module FROM modules  ";	$res = $db->Execute($mod_query);	$temp="";	while((!$res==NULL) && (!$res->EOF)) {			$mod_list .=$temp.$res->fields["module"];				$temp=",";				$res->MoveNext();				}					}	else	{          // mod_list contains the arguement values	}        $modules=shn_mm_cache_test($mod_list);	$mod_query = "SELECT module_shortname FROM mm_cache  ";	$res = $db->Execute($mod_query);	$mod_list=array();	$count=0;	while((!$res==NULL) && (!$res->EOF)) {			$mod_list[$count]= $res->fields["module_shortname"];				$res->MoveNext();			$count++;				}        $bool=true;	foreach($modules as $key=>$module)	{            $module_name=$module['module_name'];            $module_short_name=$module['module_short_name'];            $module_node_id=$module['module_node_id'];            $module_filepath=$module['module_filepath'];            $module_dependancy=$module['module_dependancy'];            $module_image_path=$module['module_image_path'];            $module_version=$module['module_version'];            $module_type=$module['module_type'];            $temp_description=getcontents("node.view",array("$module_node_id",array("body"),"",""));           $module_description=$temp_description['body'];			if(!in_array($key,$mod_list))				{							$query="INSERT INTO `mm_cache` (`module_node_id`, `module_name`, `module_version`, `module_shortname`, `module_dependancy`, `module_filepath`, `module_imagepath`,`module_description`,`status`) VALUES ('$module_node_id', '$module_name', '$module_version', '$module_short_name', '$module_dependancy', '$module_filepath', '$module_image_path','$module_description','$status')";				}			else			{			$query="UPDATE `mm_cache` SET `module_name` =  '$module_name',                                 `module_node_id` ='$module_node_id',                                `module_filepath`='$module_filepath' ,                                `module_dependancy` ='$module_dependancy',                                `module_imagepath` ='$module_image_path',                                `module_version` ='$module_version',                                `module_description`=' $module_description',                                `status`='$status',                                `time_stamp`=CURRENT_TIMESTAMP                                WHERE `mm_cache`.`module_shortname` ='$module_short_name'                                ";						}			//echo $query;		$res =	$db->Execute($query);		if($res)			{}		else                {$bool=false;}			}        if($bool)			add_information("Cache refreshed");		else			 add_error(_t("Problems updating cache"));	}function shn_mm_cache_test($mod_list){$modules=getcontents("echo.getnid_array",$mod_list);//print '<pre>'.htmlspecialchars(print_r($modules, true)) .'</pre>';	return $modules;}function shn_mm_update_applist(){    $modules=getcontents("echo.getall_modules",array("all"));   // print '<pre>'.htmlspecialchars(print_r($modules, true)) .'</pre>';    return $modules;}function shn_mm_register_appstore_modules(){    $modules_list=shn_mm_update_applist();    $modules=split(",", $modules_list);    $installed_modules=shn_mm_getlist_modules();    $available_modules=array();    foreach($modules as $module)    {        if(!in_array($module, $installed_modules))        {            array_push($available_modules, $module);        }        else        {            //        }    }   shn_mm_register_cache(false,$available_modules,"available");}function shn_mm_update_cache($status='installed'){        global $global;	global $conf;	$db=$global['db'];        $mod_query = "select 'diff',datediff(now(),min(`time_stamp`)) from mm_cache where status='$status' limit 1"; //	$res = $db->Execute($mod_query);        $result_array = $res->GetAssoc();        $difference=$result_array['diff'];        if($difference>1)        {            // update all modules cache            if(strcmp($status, 'installed'))                    shn_mm_register_cache();            else if(strcmp($status, 'available'))                    shn_mm_register_appstore_modules();            else            {                // do nothing            }        }        else        {            // need not update cache unless required        }}function shn_mm_getlist_modules(){    global $global;    global $conf;    $db=$global['db'];    $mod_query = "SELECT module,status FROM modules  ";    $res = $db->Execute($mod_query);    $result_array = $res->GetAssoc();    $modules=array();    foreach($result_array as $key=>$value)        array_push($modules, $key);    return $modules;    }